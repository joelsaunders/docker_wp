machine:
  services:
    - docker
  environment:
    commit: 
      - git rev-parse --short HEAD
    version: 
      - cat frontend/version.txt
    tag: "eu.gcr.io/beaming-might-163819/frontend-$version-$commit"

dependencies:
  override:
    - if [[ -e ~/docker/frontend.tar ]]; then docker load -i ~/docker/frontend.tar; fi
    - mkdir -p ~/docker
    - ./build_frontend.sh
    - docker save $tag > ~/docker/frontend.tar

deployment:
  staging:
    branch: [/.*/]
    commands:
      - ./deploy.sh $ENVIRONMENT deploy

