machine:
  services:
    - docker
  environment:
    COMMIT: $CIRCLE_SHA1
    BASE_TAG: "eu.gcr.io/beaming-might-163819"
    FRONTEND_TAG: "$BASE_TAG/frontend-$COMMIT"
    BACKEND_TAG: "$BASE_TAG/backend-$COMMIT"
    NGINX_TAG: "$BASE_TAG/nginx-$COMMIT"
    CLOUDSDK_COMPUTE_ZONE: europe-west1-c
    CLUSTER_NAME: europe-west1-c
    PROJECT_NAME: beaming-might-163819

dependencies:
  cache_directories:
    - ~/docker
  pre:
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update --version 120.0.0
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update --version 120.0.0 kubectl
    - echo $ACCT_AUTH | base64 --decode -i > ${HOME}/gcloud-service-key.json
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $PROJECT_NAME
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $CLUSTER_NAME
    - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${CLOUDSDK_COMPUTE_ZONE}
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $CLUSTER_NAME
  override:
    - gcloud docker -- pull eu.gcr.io/beaming-might-163819/frontend_cache:latest
    #- if [[ -e ~/docker/frontend.tar ]]; then docker load -i ~/docker/frontend.tar; fi
    #- if [[ -e ~/docker/backend.tar ]]; then docker load -i ~/docker/backend.tar; fi
    #- if [[ -e ~/docker/ngninx.tar ]]; then docker load -i ~/docker/nginx.tar; fi        
    - mkdir -p ~/docker
    - ./build_images.sh
    #- docker save $FRONTEND_TAG > ~/docker/frontend.tar
    #- docker save $FRONTEND_TAG > ~/docker/backend.tar
    #- docker save $FRONTEND_TAG > ~/docker/frontend.tar
    - gcloud docker -- build -t eu.gcr.io/beaming-might-163819/frontend_cache ./frontend
    - gcloud docker -- push eu.gcr.io/beaming-might-163819/frontend_cache

deployment:
  staging:
    branch: [/.*/]
    commands:
      - ./deploy.sh $ENVIRONMENT deploy

