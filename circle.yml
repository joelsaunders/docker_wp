machine:
  services:
    - docker
  environment:
    COMMIT: $CIRCLE_SHA1
    BASE_TAG: "eu.gcr.io/beaming-might-163819"
    FRONTEND_TAG: "$BASE_TAG/frontend-$COMMIT"
    BACKEND_TAG: "$BASE_TAG/backend-$COMMIT"
    NGINX_TAG: "$BASE_TAG/nginx-$COMMIT"

dependencies:
  cache_directories:
    - ~/docker
  override:
    #- if [[ -e ~/docker/frontend.tar ]]; then docker load -i ~/docker/frontend.tar; fi
    #- if [[ -e ~/docker/backend.tar ]]; then docker load -i ~/docker/backend.tar; fi
    #- if [[ -e ~/docker/ngninx.tar ]]; then docker load -i ~/docker/nginx.tar; fi        
    - mkdir -p ~/docker
    #- ./build_images.sh
    #- docker save $FRONTEND_TAG > ~/docker/frontend.tar
    #- docker save $FRONTEND_TAG > ~/docker/backend.tar
    #- docker save $FRONTEND_TAG > ~/docker/frontend.tar    

deployment:
  staging:
    branch: [/.*/]
    commands:
      - ./deploy.sh $ENVIRONMENT deploy

