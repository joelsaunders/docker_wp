machine:
  services:
    - docker
  environment:
    COMMIT: $CIRCLE_SHA1
    BASE_TAG: "eu.gcr.io/beaming-might-163819"
    FRONTEND_TAG: "$BASE_TAG/frontend-$commit"
    BACKEND_TAG: "$BASE_TAG/backend-$commit"
    NGINX_TAG: "$BASE_TAG/nginx-$commit"

dependencies:
  cache_directories:
    - ~/docker
  override:
    - if [[ -e ~/docker/frontend.tar ]]; then docker load -i ~/docker/frontend.tar; fi
    - mkdir -p ~/docker
    - ./build_images.sh
    - docker save $FRONTEND_TAG > ~/docker/frontend.tar

deployment:
  staging:
    branch: [/.*/]
    commands:
      - ./deploy.sh $ENVIRONMENT deploy

